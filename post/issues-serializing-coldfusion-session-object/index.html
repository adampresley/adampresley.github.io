<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Adam.Blog()</title>
        <meta name="author">
        <meta name="description" content="I&#39;m bringin&#39; nerdy back">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.16-DEV" />
          <link href="http://adampresley.com/post/index.xml" rel="alternate" type="application/rss+xml" title="Adam.Blog()" />
          <link href="http://adampresley.com/post/index.xml" rel="feed" type="application/rss+xml" title="Adam.Blog()" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://adampresley.com/css/styles.css">
        <link rel="icon" href="http://adampresley.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://adampresley.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://adampresley.com/css/highlightjs/monokai.css">
        <script src="http://adampresley.com/js/vendor/modernizr-2.8.0.min.js"></script>
        <style>
        .site-header h2 .logo {
        background: url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://adampresley.com/assets/images/code-background-screenshot.png);
        }}
       .site-header {
         background: #2a373d url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2>Adam.Blog()</h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://adampresley.com/" title="">&laquo; </a>
            
<h1><a href="http://adampresley.com/post/issues-serializing-coldfusion-session-object/" title="Issues Serializing ColdFusion Session Object">Issues Serializing ColdFusion Session Object</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2009.06.24">2009.06.24</time>

    &middot; 
        
        <a href="http://adampresley.com/tags/development">development</a>, 
        
        <a href="http://adampresley.com/tags/coldfusion">coldfusion</a>
        
    

</span>
</footer>

            <p>At work I&rsquo;ve been asked to brainstorm solutions to a problem where a
user&rsquo;s session and application information is lost when they get kicked
off of one server and are moved to another. Essentialy we have a load
balancer with &ldquo;sticky session&rdquo; support, so a user, once logged into our
application, goes onto a web server, and stays there. Should that web
server crash, however, they will get moved to the next web server. That
next server, however, has no knowledge of this user&rsquo;s application and
session information, thus forcing them to log in to our application
again. This isn&rsquo;t optimal.</p>

<p>Now, before you ask, I have already been told that, in these difficult
economic times, we will <strong>NOT</strong> be purchasing ColdFusion Enterprise to
handle sessions across a cluster. This is why I am working on a
&ldquo;home-grown&rdquo; solution, despite the fact that Adobe has already gone
through the trouble. I digress.</p>

<p>So here&rsquo;s the concept. When a request is finished, serialize the SESSION
scope (and a few others, but we&rsquo;ll conveniently ignore that for now) to
some type of persistent, or semi-persistent medium, such as a database,
or remote cache server like <a href="http://jakarta.apache.org/jcs/index.html">Apache Jakarta JCS</a> (which looks cool
BTW). That&rsquo;s fine and all, but the problem is that the SESSION object,
which is effectively a Java HashTable, must be transformed, or
serialized, into some format that can be stored.</p>

<p>WDDX is a fairly attractive option, as it is built in, works, and can
turn the SESSION object into XML. There are two factors that deter me
from this, however. The first is that the XML produced by CFWDDX is huge
and bloated, and our SESSION scope isn&rsquo;t exactly small. The second is
performance. I&rsquo;m concerned that serializing and deserializing to and
from this format could be time consuming for EVERY request.</p>

<p>It was at this point that I decided to delve into the Java documentation
and see what was available. I came across the java.io.ObjectOutputStream
class. This class is specifically designed to transform objects into a
binary format suitable for transport and storage. Sweet. So I cooked up
a sample that creates a SESSION object, puts some values in it,
structure and arrays, and then serializes it to a byte array stream so I
can dump it to a page and see what it looks like. From there I wanted to
deserialize it BACK to the SESSION scope. Let&rsquo;s take a look at this code
and the resulting page.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.key1</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;value1&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.key2</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;value2&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.key3</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;value3&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.somethingcomplex</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;arrayNew(1)&quot;</span><span style="color: #f8f8f2">&gt;</span>
 <span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.somethingcomplex[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;array1&quot;</span><span style="color: #f8f8f2">&gt;</span>
 <span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.somethingcomplex[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;array2&quot;</span><span style="color: #f8f8f2">&gt;</span>
 <span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.somethingcomplex[</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;array3&quot;</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.another</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;structNew()&quot;</span><span style="color: #f8f8f2">&gt;</span>
 <span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.another.hey1</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;hey1&quot;</span><span style="color: #f8f8f2">&gt;</span>
 <span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #66d9ef">session</span><span style="color: #f8f8f2">.another.hey2</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;hey2&quot;</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #f8f8f2">&lt;cfoutput&gt;</span>


<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #e6db74">&quot;java.io.bytearrayoutputstream&quot;</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">init</span><span style="color: #f8f8f2">()</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span> <span style="color: #f8f8f2">outbytestream</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;createObject(&quot;</span><span style="color: #f8f8f2">java</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #e6db74">&quot;java.io.objectoutputstream&quot;</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">init</span><span style="color: #f8f8f2">(outbytestream)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span> <span style="color: #f8f8f2">oos</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;createObject(&quot;</span><span style="color: #f8f8f2">java</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #a6e22e">oos.writeobject</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">session</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #a6e22e">oos.close</span><span style="color: #f8f8f2">()</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">&gt;</span>


<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #f8f8f2">serialized</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;outByteStream.toByteArray()&quot;</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">strong</span><span style="color: #f8f8f2">&gt;</span>SESSION as a byte array (<span style="color: #f8f8f2">#</span><span style="color: #a6e22e">outByteStream.size</span><span style="color: #f8f8f2">()#</span> bytes).<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">strong</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfdump</span> <span style="color: #f8f8f2">expand</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;false&quot;</span> <span style="color: #66d9ef">var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;#serialized#&quot;</span><span style="color: #f8f8f2">&gt;</span>




<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #e6db74">&quot;java.io.bytearrayinputstream&quot;</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">init</span><span style="color: #f8f8f2">(serialized)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span> <span style="color: #f8f8f2">inbytestream</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;createObject(&quot;</span><span style="color: #f8f8f2">java</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #e6db74">&quot;java.io.objectinputstream&quot;</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">init</span><span style="color: #f8f8f2">(inbytestream)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span> <span style="color: #f8f8f2">ois</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;createObject(&quot;</span><span style="color: #f8f8f2">java</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #f8f8f2">deserialze</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;ois.readObject()&quot;</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfset</span> <span style="color: #f8f8f2">deserialze)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span> <span style="color: #a6e22e">structappend</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">session</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">&gt;</span>


<span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">strong</span><span style="color: #f8f8f2">&gt;</span>Restored SESSION scope: <span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">strong</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;cfdump</span> <span style="color: #f8f8f2">expand</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;false&quot;</span> <span style="color: #66d9ef">var</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;#SESSION#&quot;</span><span style="color: #f8f8f2">&gt;</span>
</pre></div>


<p>As you can see in the first dump we have a binary representation of the
SESSION object. And the second dump is quite promising with one
exception. The array in the SESSION object did not deserialize properly.
Interestingly I started digging around and discovered other people that
have run into the very same issue, with no apparent resolution.</p>

<p>The good news here is that I think we might be able to get away with not
storing arrays in our SESSION, but I&rsquo;m hoping CF 9 addresses this issue.</p>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fadampresley.com%2fpost%2fissues-serializing-coldfusion-session-object%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=Issues%20Serializing%20ColdFusion%20Session%20Object&amp;url=http%3a%2f%2fadampresley.com%2fpost%2fissues-serializing-coldfusion-session-object%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fadampresley.com%2fpost%2fissues-serializing-coldfusion-session-object%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fadampresley.com%2fpost%2fissues-serializing-coldfusion-session-object%2f&title=Issues%20Serializing%20ColdFusion%20Session%20Object" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'adampresleyblog';
    var disqus_identifier = 'http:\/\/adampresley.com\/post\/issues-serializing-coldfusion-session-object\/';
    var disqus_title = 'Issues Serializing ColdFusion Session Object';
    var disqus_url = 'http:\/\/adampresley.com\/post\/issues-serializing-coldfusion-session-object\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
  <img class="profile-image" src="http://adampresley.com/assets/adampresley/images/adam-bowtie.png" alt="Adam Presley" />
  <p class="name"> 
  <strong>Adam Presley</strong></p>
  <p class="address">Texas, USA</p>
  <p class="link"></p>
  <ul class="social">
    
<li><a href="//twitter.com/adampresley" class="icon-twitter" target="_blank" title="Twitter"></a></li>













<li><a href="//github.com/adampresley" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://adampresley.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://adampresley.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2016 &middot; Adam Presley. All Rights Reserved. Powered by <a href="http://gohugo.io">Hugo</a>.</p>
  </div>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/adampresley.com\/js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://adampresley.com/js/plugins.js"></script>

<!-- Google Analytics -->
<script>
  var _gaq=[['_setAccount','UA-44927419-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

