<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Adam.Blog()</title>
        <meta name="author">
        <meta name="description" content="I&#39;m bringin&#39; nerdy back">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.16-DEV" />
          <link href="http://adampresley.com/post/index.xml" rel="alternate" type="application/rss+xml" title="Adam.Blog()" />
          <link href="http://adampresley.com/post/index.xml" rel="feed" type="application/rss+xml" title="Adam.Blog()" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://adampresley.com/css/styles.css">
        <link rel="icon" href="http://adampresley.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://adampresley.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://adampresley.com/css/highlightjs/monokai.css">
        <script src="http://adampresley.com/js/vendor/modernizr-2.8.0.min.js"></script>
        <style>
        .site-header h2 .logo {
        background: url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://adampresley.com/assets/images/code-background-screenshot.png);
        }}
       .site-header {
         background: #2a373d url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2>Adam.Blog()</h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://adampresley.com/" title="">&laquo; </a>
            
<h1><a href="http://adampresley.com/post/simple-lru-cache-class-in-php/" title="Simple LRU Cache Class in PHP">Simple LRU Cache Class in PHP</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2009.05.27">2009.05.27</time>

    &middot; 
        
        <a href="http://adampresley.com/tags/development">development</a>, 
        
        <a href="http://adampresley.com/tags/php">php</a>
        
    

</span>
</footer>

            <p>In my ongoing effort to further enhance my PHP framework I started
recently working on a caching mechanism. For the time being I am using
the PEAR library&rsquo;s <a href="http://pear.php.net/package/Cache_Lite">Cache_Lite</a>
(I&rsquo;ve blogged on this before, so <a href="#post/2007/05/caching-in-php-cache_lite">check it out</a>)
to handle the details of persisting the cache data,
locking, and all that fun jazz. Cache_Lite, however, is a pretty simple
library and does not implement any particular algorithm regarding how
much cache to keep, or what stays in cache and what goes. It offers an
expiration mechanism, but that&rsquo;s about it. So with that in mind I set off
to learn about various caching and paging algorithms. They range, I
found out, from simple to complex.</p>

<p>In this blog entry I will demonstrate the creation of a very simple LRU,
or Least Recently Used, caching algorithm. I will provide downloads for
PHP source code at the end of this entry.</p>

<p>First let&rsquo;s talk about how the algorithm works. The concept behind LRU
is that you have a finite set of <em>slots</em> in some container. Our
container will be an array for simplicity. The LRU algorithm works off
the premise that you keep only the most recently used items in your
container, and those that get accessed are moved to the top of the
array. Adding a new item to the container will be put in at the top of
the array, and all subsequent items are shifted down. Any item at the
bottom of the array is dropped off from the container.</p>

<p>Items in the LRU array are going to be stored as a structure (array in
PHP) consisting of a <em>key</em> and <em>element</em>, which we will call a <em>node</em>.
The <em>element</em> is simply whatever data is to be stored. The <em>key</em> is the
identifier for the data element, and how we are able to insert and
retrieve elements, or items, from the array.</p>

<p>There are two primary operations to supprt this: <strong>get</strong> and <strong>put</strong>.
Let&rsquo;s start with <strong>put</strong> as it is the simplest in concept. The first
thing the <strong>put</strong> operation must do is <em>evict</em> any element at the bottom
of the array, then shift all of the elements above down one notch. So,
for example, of you have an array of 5 slots, and you are adding a new
element, you will remove the last item in the array (slot 4), then shift
items in slots 0 through 3 down into slots 1 through 4. From here you
then insert the new item into slot 0. Let&rsquo;s take a look at how that
works.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">&lt;?php</span>

<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">function</span> <span style="color: #a6e22e">put</span><span style="color: #f8f8f2">($key,</span> <span style="color: #f8f8f2">$element)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__evict</span><span style="color: #f8f8f2">();</span>
	<span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__createNode</span><span style="color: #f8f8f2">($key,</span> <span style="color: #f8f8f2">$element);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">private</span> <span style="color: #66d9ef">function</span> <span style="color: #a6e22e">__evict</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #f8f8f2">$index</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
	<span style="color: #f8f8f2">$newPosition</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>

	<span style="color: #f8f8f2">array_pop($this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">);</span> <span style="color: #75715e">// Drop off the element in the last slot.</span>
	<span style="color: #f8f8f2">array_unshift($this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span> <span style="color: #75715e">// Shift every element down one, and insert blank at the top.</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">private</span> <span style="color: #66d9ef">function</span> <span style="color: #a6e22e">__createNode</span><span style="color: #f8f8f2">($key,</span> <span style="color: #f8f8f2">$element)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">array</span><span style="color: #f8f8f2">(</span>
		<span style="color: #e6db74">&quot;key&quot;</span> <span style="color: #f92672">=&gt;</span> <span style="color: #f8f8f2">$key,</span>
		<span style="color: #e6db74">&quot;element&quot;</span> <span style="color: #f92672">=&gt;</span> <span style="color: #f8f8f2">$element</span>
	<span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">?&gt;</span>
</pre></div>


<p>Ok, that was easy enough. Now let&rsquo;s talk about the <strong>get</strong> operation.
<strong>Get</strong> starts with taking a single argument called <em>key</em>. It then
attempts to find the correct node by looping over the container array,
retrieving a node each iteration, then comparing the node&rsquo;s key to the
argument key. If we have a match we want to MOVE this node to the
<strong>top</strong> of the array since it is the most recently used node. Once this
is done we return the node. Here&rsquo;s what that looks like.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">&lt;?php</span>

<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">function</span> <span style="color: #a6e22e">get</span><span style="color: #f8f8f2">($key)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #f8f8f2">$index</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
	<span style="color: #f8f8f2">$node</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">;</span>

	<span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">($index</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">$index</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__maxElements</span><span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">$index</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #f8f8f2">$node</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">[$index];</span>

		<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(is_array($node))</span> <span style="color: #f8f8f2">{</span>
			<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">($node[</span><span style="color: #e6db74">&quot;key&quot;</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">===</span> <span style="color: #f8f8f2">$key)</span> <span style="color: #f8f8f2">{</span>
				<span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__moveToHead</span><span style="color: #f8f8f2">($index);</span>
				<span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__stats</span><span style="color: #f8f8f2">[</span><span style="color: #e6db74">&quot;cacheHits&quot;</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
				<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">$node[</span><span style="color: #e6db74">&quot;element&quot;</span><span style="color: #f8f8f2">];</span>
			<span style="color: #f8f8f2">}</span>
		<span style="color: #f8f8f2">}</span>
	<span style="color: #f8f8f2">}</span>

	<span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__stats</span><span style="color: #f8f8f2">[</span><span style="color: #e6db74">&quot;cacheMisses&quot;</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
	<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">private</span> <span style="color: #66d9ef">function</span> <span style="color: #a6e22e">__moveToHead</span><span style="color: #f8f8f2">($index)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">($index</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>

	<span style="color: #f8f8f2">$element</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">array_splice($this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$index,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
	<span style="color: #f8f8f2">array_unshift($this</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">__container</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$element[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">?&gt;</span>
</pre></div>
</p>

<p>Using this class is pretty easy, so here is a simple test that provides
a series of data items, and a comma-delimited pattern of indexes to
those data items. The code then iterates over this list, simulating some
part of a program that is being asked for some data, and it attempts to
get the data from the cache. If it does not have it the code then puts
the data into the cache.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">&lt;?php</span>

<span style="color: #66d9ef">require_once</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;LRUCache.php&quot;</span><span style="color: #f8f8f2">);</span>

<span style="color: #f8f8f2">$lru</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">LRUCache</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>

<span style="color: #f8f8f2">$db</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">array</span><span style="color: #f8f8f2">(</span>
	<span style="color: #e6db74">&quot;This is item 0&quot;</span><span style="color: #f8f8f2">,</span>
	<span style="color: #e6db74">&quot;This is item 1&quot;</span><span style="color: #f8f8f2">,</span>
	<span style="color: #e6db74">&quot;This is item 2&quot;</span><span style="color: #f8f8f2">,</span>
	<span style="color: #e6db74">&quot;This is item 3&quot;</span><span style="color: #f8f8f2">,</span>
	<span style="color: #e6db74">&quot;This is item 4&quot;</span><span style="color: #f8f8f2">,</span>
	<span style="color: #e6db74">&quot;This is item 5&quot;</span>
<span style="color: #f8f8f2">);</span>

<span style="color: #f8f8f2">$testPattern</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;0,2,4,1,0,5,3,1,5,3,0,1,5,2,5,1,4&quot;</span><span style="color: #f8f8f2">;</span>

<span style="color: #75715e">// Implement test pattern.</span>
<span style="color: #66d9ef">foreach</span> <span style="color: #f8f8f2">(explode(</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$testPattern)</span> <span style="color: #66d9ef">as</span> <span style="color: #f8f8f2">$index)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #f8f8f2">$item</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$lru</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">get</span><span style="color: #f8f8f2">($index);</span>

	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">($item</span> <span style="color: #f92672">!==</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Cache hit. - %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$item);</span>
	<span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Cache miss for key %s. Adding %s to cache.</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$index,</span> <span style="color: #f8f8f2">$db[$index]);</span>
		<span style="color: #f8f8f2">$lru</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">put</span><span style="color: #f8f8f2">($index,</span> <span style="color: #f8f8f2">$db[$index]);</span>
	<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">$stats</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$lru</span><span style="color: #f92672">-&gt;</span><span style="color: #a6e22e">getCacheStats</span><span style="color: #f8f8f2">();</span>

<span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Hits: %s&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$stats[</span><span style="color: #e6db74">&quot;cacheHits&quot;</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Misses: %s&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$stats[</span><span style="color: #e6db74">&quot;cacheMisses&quot;</span><span style="color: #f8f8f2">]);</span>

<span style="color: #75715e">?&gt;</span>
</pre></div>
</p>

<p>Go ahead, mess with the test pattern and see how many cache hits vs
cache misses there are. Kinda neat.</p>

<p>Happy coding!</p>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fadampresley.com%2fpost%2fsimple-lru-cache-class-in-php%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=Simple%20LRU%20Cache%20Class%20in%20PHP&amp;url=http%3a%2f%2fadampresley.com%2fpost%2fsimple-lru-cache-class-in-php%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fadampresley.com%2fpost%2fsimple-lru-cache-class-in-php%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fadampresley.com%2fpost%2fsimple-lru-cache-class-in-php%2f&title=Simple%20LRU%20Cache%20Class%20in%20PHP" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'adampresleyblog';
    var disqus_identifier = 'http:\/\/adampresley.com\/post\/simple-lru-cache-class-in-php\/';
    var disqus_title = 'Simple LRU Cache Class in PHP';
    var disqus_url = 'http:\/\/adampresley.com\/post\/simple-lru-cache-class-in-php\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
  <img class="profile-image" src="http://adampresley.com/assets/adampresley/images/adam-bowtie.png" alt="Adam Presley" />
  <p class="name"> 
  <strong>Adam Presley</strong></p>
  <p class="address">Texas, USA</p>
  <p class="link"></p>
  <ul class="social">
    
<li><a href="//twitter.com/adampresley" class="icon-twitter" target="_blank" title="Twitter"></a></li>













<li><a href="//github.com/adampresley" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://adampresley.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://adampresley.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2016 &middot; Adam Presley. All Rights Reserved. Powered by <a href="http://gohugo.io">Hugo</a>.</p>
  </div>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/adampresley.com\/js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://adampresley.com/js/plugins.js"></script>

<!-- Google Analytics -->
<script>
  var _gaq=[['_setAccount','UA-44927419-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

