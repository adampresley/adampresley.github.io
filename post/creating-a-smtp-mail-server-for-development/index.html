<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Adam.Blog()</title>
        <meta name="author">
        <meta name="description" content="I&#39;m bringin&#39; nerdy back">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.16-DEV" />
          <link href="http://adampresley.com/post/index.xml" rel="alternate" type="application/rss+xml" title="Adam.Blog()" />
          <link href="http://adampresley.com/post/index.xml" rel="feed" type="application/rss+xml" title="Adam.Blog()" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://adampresley.com/css/styles.css">
        <link rel="icon" href="http://adampresley.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://adampresley.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://adampresley.com/css/highlightjs/monokai.css">
        <script src="http://adampresley.com/js/vendor/modernizr-2.8.0.min.js"></script>
        <style>
        .site-header h2 .logo {
        background: url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://adampresley.com/assets/images/code-background-screenshot.png);
        }}
       .site-header {
         background: #2a373d url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2>Adam.Blog()</h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://adampresley.com/" title="">&laquo; </a>
            
<h1><a href="http://adampresley.com/post/creating-a-smtp-mail-server-for-development/" title="Creating a SMTP Mail Server for Development">Creating a SMTP Mail Server for Development</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2010.07.20">2010.07.20</time>

    &middot; 
        
        <a href="http://adampresley.com/tags/development">development</a>, 
        
        <a href="http://adampresley.com/tags/java">java</a>
        
    

</span>
</footer>

            <p>While working on ColdFusion applications with Railo on Tomcat I have
been piecing together tools necessary to get these applications to do
everything I need them to do. So I&rsquo;ve bolted on Hibernate, a URL
rewriter, and so on. Now I found myself needing an SMTP server of some
type so that emails generated by the application don&rsquo;t create a
ColdFusion error. I then thought to myself, &ldquo;Wouldn&rsquo;t it be fun to write
a small SMTP server?&rdquo; So I did.</p>

<p>The design objectives behind this little server are simple. Accept
incoming SMTP requests on port 25, respond accordingly, and throw away
the mail. I&rsquo;m not even concerned about actually relaying or sending the
message. I just need to make sure my ColdFusion application is satisfied
that a mail was given to a mail server.</p>

<p>So what we are going to talk about in this blog entry is the basics of
how to do this in Java. In a future post I&rsquo;ll look at integrating this
into Tomcat so the SMTP server starts with Tomcat. The tools I will use
in this blog entry are simple: Eclipse.</p>

<p>To get started create a new Java Project in Eclipse. I called mine
<strong>TinyMailServer</strong>, and I used the Java JRE version 1.6. From here
your code will need a package to live in. For mine I used
<strong>com.adampresley.TinyMailServer</strong>.</p>

<p>There are three classes we are going to create: <em>Main</em>,
<em>SmtpServer</em>, and <em>SmtpExecutor</em>. Let&rsquo;s start with Main. Right click
on your Java package and choose New -&gt; Class. In the field labeled
<em>Name</em> type in &ldquo;Main&rdquo;. Also check the checkbox labeled &ldquo;public static
void main(String[] args)&ldquo;. This will make an entry point for our
executable Java application.</p>

<p>Now we&rsquo;ll need two more classes, so do the right click thing again. This
time we will <strong>not</strong> check the checkbox for making a Main method.
The two classes will be named <em>SmtpServer</em> and <em>SmtpExecutor</em>.</p>

<p>Let&rsquo;s start with the <em>SmtpServer</em> class. This class will be
instantiated by our Main method and actually binds to port 25 for
incoming connections. We also want this to execute in a separate thread.
As such we will need to make sure the class extends the <em>Thread</em>
class.</p>

<p>When building servers you must have your application bind to a socket at
an address on a port. To do this in Java you use the
<em>java.net.ServerSocket</em> class, which provides an easy way to bind to
the address and port as well as listen for incoming connections. So this
class we are building will create the socket object in the constructor,
and then will start our thread. When the thread is started the
<strong>run()</strong> method is executed, and this method will actually do the
dirty work of listening for connections on port 25, and when a
connection is received will actually do something. Let&rsquo;s see that code.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">package</span> <span style="color: #f8f8f2">com.adampresley.TinyMailServer</span><span style="color: #f92672">;</span>

<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.net.*</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.*</span><span style="color: #f92672">;</span>

<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">SmtpServer</span> <span style="color: #66d9ef">extends</span> <span style="color: #f8f8f2">Thread</span> <span style="color: #f92672">{</span>
 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">address</span><span style="color: #f92672">;</span>
 <span style="color: #66d9ef">private</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">port</span><span style="color: #f92672">;</span>
 <span style="color: #66d9ef">private</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">maxRequestsInQueue</span><span style="color: #f92672">;</span>

 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">ServerSocket</span> <span style="color: #f8f8f2">connection</span><span style="color: #f92672">;</span>
 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">Logger</span> <span style="color: #f8f8f2">log</span><span style="color: #f92672">;</span>

 <span style="color: #66d9ef">public</span> <span style="color: #a6e22e">SmtpServer</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">Address</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">Port</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">MaxRequestsInQueue</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">UnknownHostException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">address</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Address</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">port</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Port</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">maxRequestsInQueue</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">MaxRequestsInQueue</span><span style="color: #f92672">;</span>

    <span style="color: #75715e">/*</span>
<span style="color: #75715e">     * Prepare to bind to an address and port.</span>
<span style="color: #75715e">     */</span>
    <span style="color: #f8f8f2">connection</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">ServerSocket</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">port</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">maxRequestsInQueue</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">InetAddress</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getByName</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">address</span><span style="color: #f92672">));</span>

    <span style="color: #75715e">/*</span>
<span style="color: #75715e">     * Start our thread&#39;s processing.</span>
<span style="color: #75715e">     */</span>
    <span style="color: #f8f8f2">start</span><span style="color: #f92672">();</span>
 <span style="color: #f92672">}</span>

 <span style="color: #a6e22e">@Override</span>
 <span style="color: #66d9ef">public</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">run</span><span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
       <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;SMTP Listener started.&quot;</span><span style="color: #f92672">);</span>

       <span style="color: #66d9ef">do</span> <span style="color: #f92672">{</span>
          <span style="color: #75715e">/*</span>
<span style="color: #75715e">           * Attempt to start listening for incoming connections.</span>
<span style="color: #75715e">           */</span>
          <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Accepting connections.&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #f8f8f2">Socket</span> <span style="color: #f8f8f2">socket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">connection</span><span style="color: #f92672">.</span><span style="color: #a6e22e">accept</span><span style="color: #f92672">();</span>

             <span style="color: #f8f8f2">Thread</span> <span style="color: #f8f8f2">executor</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">SmtpExecutor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">socket</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">log</span><span style="color: #f92672">);</span>
             <span style="color: #f8f8f2">executor</span><span style="color: #f92672">.</span><span style="color: #a6e22e">start</span><span style="color: #f92672">();</span>
          <span style="color: #f92672">}</span>
          <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">IOException</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">format</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;An exception occured while attempting to listen for connections: %s&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getMessage</span><span style="color: #f92672">());</span>
             <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
             <span style="color: #66d9ef">break</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

       <span style="color: #f92672">}</span> <span style="color: #66d9ef">while</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Throwable</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
       <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">format</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;An exception occured during the listener loop: %s&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getMessage</span><span style="color: #f92672">());</span>
    <span style="color: #f92672">}</span>
 <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>


<p>In the code above there is quite a bit of error handling, stack dumping,
etc&hellip; The most interesting part is the loop. In this loop we call the
<strong>accept()</strong> method on the <em>ServerSocket</em> class. This method stops
the thread and waits for someone to talk to it. So when a connection
comes in on port 25 the connection is accepted and execution resumes.</p>

<p>This is where our next class, <em>SmtpExecutor</em>, comes into play. Once
the connection is accepted we instantiate an instance of this class and
tell it to start. An since the <em>SmtpExecutor</em> class extends the
<em>Thread</em> class it starts a new thread, and execution of this listener
loop continues, waiting for the next connection.</p>

<p>Now let&rsquo;s look at the <em>SmtpExecutor</em> class. This is the one that does
the bulk of the work. First off it extends <em>Thread</em> so we can handle
incoming connections in new threads. As such this class must override
the <strong>run()</strong> method, just like the <em>SmtpServer</em> class did.</p>

<p>Before we do that, however, the constructor does a little work. The
<em>SmtpServer</em> class, when it instantiates the <em>SmtpExecutor</em> class,
passes in a copy of the socket object that has the connection. With this
we need to get a reader and writer connected to the socket&rsquo;s in and out
streams. This allows us to read the incoming request, and write
responses back out to the socket.</p>

<p>So once the thread starts running the first objective is to tell the
client connecting to our socket that we are ready for additional
commands. We do this by sending &ldquo;220 SMTP Server TinyMailServer ready
and waiting.&rdquo; to the output stream. This signals to the client that we
can receive more commands.</p>

<p>From here we will do a loop, reading in data form the input stream,
until we receive the final command, &ldquo;<strong>QUIT</strong>&rdquo;. But I&rsquo;m jumping
ahead a bit. Here&rsquo;s how an SMTP server works.</p>

<ul>
<li>A connection is made by the client to the server</li>
<li>A status code of 220 signals to the client we are ready for more commands</li>
<li>Commands are sent by the client to the server, each in the form of <strong>COMMAND: data</strong>, followed by return</li>
<li>Commands are acted upon, and responses for each sent</li>
<li>Commands are processed until we receive the QUIT command. Send a status code of 221 and break the loop</li>
<li>Close the socket connection</li>
</ul>

<p>There are a number of commands to process, and I only cover eight. The
only ones that deserve special attention for my purposes are the DATA
and QUIT commands. The QUIT command because we need to stop processing
and close the socket. The DATA command indicates that we are going to
get the mail headers and data. For this one we send another status code,
354, and tell the client how to terminate the data transmission by
sending &ldquo;End with <something>&rdquo;. For us the something will be a
period.</p>

<p>After that status is sent we will read from the input stream until the
period is sent. Once the terminating period is sent we send a status 250
to indicate we are ready for the next command.</p>

<p>Whew, that&rsquo;s a lot to cover! Let&rsquo;s see that code now!</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">package</span> <span style="color: #f8f8f2">com.adampresley.TinyMailServer</span><span style="color: #f92672">;</span>

<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.BufferedReader</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.IOException</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.InputStreamReader</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.OutputStreamWriter</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.PrintWriter</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.net.Socket</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.util.StringTokenizer</span><span style="color: #f92672">;</span>

<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">SmtpExecutor</span> <span style="color: #66d9ef">extends</span> <span style="color: #f8f8f2">Thread</span> <span style="color: #f92672">{</span>
 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">Socket</span> <span style="color: #f8f8f2">__socket</span><span style="color: #f92672">;</span>

 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">BufferedReader</span> <span style="color: #f8f8f2">__inStream</span><span style="color: #f92672">;</span>
 <span style="color: #66d9ef">private</span> <span style="color: #f8f8f2">PrintWriter</span> <span style="color: #f8f8f2">__outStream</span><span style="color: #f92672">;</span>

 <span style="color: #66d9ef">public</span> <span style="color: #a6e22e">SmtpExecutor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Socket</span> <span style="color: #f8f8f2">socket</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">__socket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">socket</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">__inStream</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">BufferedReader</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">InputStreamReader</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">socket</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getInputStream</span><span style="color: #f92672">()));</span>
    <span style="color: #f8f8f2">__outStream</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">PrintWriter</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">OutputStreamWriter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">socket</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getOutputStream</span><span style="color: #f92672">()));</span>
 <span style="color: #f92672">}</span>

 <span style="color: #a6e22e">@Override</span>
 <span style="color: #66d9ef">public</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">run</span><span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;220 SMTP Server TinyMailServer ready and waiting.&quot;</span><span style="color: #f92672">);</span>

    <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
       <span style="color: #66d9ef">do</span> <span style="color: #f92672">{</span>
          <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">input</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">;</span>

          <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">input</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">__inStream</span><span style="color: #f92672">.</span><span style="color: #a6e22e">readLine</span><span style="color: #f92672">();</span>

             <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">input</span> <span style="color: #f92672">==</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">)</span>
                <span style="color: #66d9ef">break</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>
          <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Exception</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
          <span style="color: #f92672">}</span>

          <span style="color: #75715e">/*</span>
<span style="color: #75715e">           * Parse commands. For now we just ignore the command</span>
<span style="color: #75715e">           * and say all is ok.</span>
<span style="color: #75715e">           */</span>
          <span style="color: #f8f8f2">StringTokenizer</span> <span style="color: #f8f8f2">tokenizer</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">StringTokenizer</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">input</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot; :&quot;</span><span style="color: #f92672">);</span>
          <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">command</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">;</span>

          <span style="color: #f8f8f2">command</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">tokenizer</span><span style="color: #f92672">.</span><span style="color: #a6e22e">nextToken</span><span style="color: #f92672">().</span><span style="color: #a6e22e">toUpperCase</span><span style="color: #f92672">();</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;DATA&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">doCommand_DATA</span><span style="color: #f92672">();</span>
             <span style="color: #66d9ef">continue</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;RCPT&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;250 OK, RCPT received&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #66d9ef">continue</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">((</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;MAIL&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">||</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;SEND&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">))</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;250 OK, MAIL/SEND received&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #66d9ef">continue</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">((</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;HELO&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">||</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;EHLO&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">))</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">println</span> <span style="color: #f92672">(</span><span style="color: #e6db74">&quot;250 OK, Howdy ya&#39;ll!&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #66d9ef">continue</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;RSET&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;250 OK, RSET received&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #66d9ef">continue</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>

          <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">command</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compareTo</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;QUIT&quot;</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
             <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;221 SMTP Server TinyMailServer closing transmission channel&quot;</span><span style="color: #f92672">);</span>
             <span style="color: #66d9ef">break</span><span style="color: #f92672">;</span>
          <span style="color: #f92672">}</span>
       <span style="color: #f92672">}</span> <span style="color: #66d9ef">while</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Exception</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
       <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">finally</span> <span style="color: #f92672">{</span>
       <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
          <span style="color: #f8f8f2">__socket</span><span style="color: #f92672">.</span><span style="color: #a6e22e">close</span><span style="color: #f92672">();</span>
       <span style="color: #f92672">}</span>
       <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Exception</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
       <span style="color: #f92672">}</span>
    <span style="color: #f92672">}</span>
 <span style="color: #f92672">}</span>

 <span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">s</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">__outStream</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">__outStream</span><span style="color: #f92672">.</span><span style="color: #a6e22e">flush</span><span style="color: #f92672">();</span>

    <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">);</span>
 <span style="color: #f92672">}</span>

 <span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">doCommand_DATA</span><span style="color: #f92672">()</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;354 Send me data yo. End with .&quot;</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Mail:&quot;</span><span style="color: #f92672">);</span>

    <span style="color: #66d9ef">do</span> <span style="color: #f92672">{</span>
       <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">input</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">__inStream</span><span style="color: #f92672">.</span><span style="color: #a6e22e">readLine</span><span style="color: #f92672">();</span>
       <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">equals</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;.&quot;</span><span style="color: #f92672">))</span> <span style="color: #f92672">{</span>
          <span style="color: #f8f8f2">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;250 OK&quot;</span><span style="color: #f92672">);</span>
          <span style="color: #66d9ef">break</span><span style="color: #f92672">;</span>
       <span style="color: #f92672">}</span>
       <span style="color: #66d9ef">else</span> <span style="color: #f92672">{</span>
          <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">input</span><span style="color: #f92672">);</span>
       <span style="color: #f92672">}</span>
    <span style="color: #f92672">}</span> <span style="color: #66d9ef">while</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
 <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>
</p>

<p>Ok, so we&rsquo;ve got a server to listen for connections. When a connection
is received we fire off a thread that actually response to the client,
then terminates the socket connection. Now we need to tie it together in
the <em>Main</em> class. This part is easy. Instantiate and run. :) Let&rsquo;s see
it.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">package</span> <span style="color: #f8f8f2">com.adampresley.TinyMailServer</span><span style="color: #f92672">;</span>

<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.io.IOException</span><span style="color: #f92672">;</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">java.net.UnknownHostException</span><span style="color: #f92672">;</span>

<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Main</span> <span style="color: #f92672">{</span>
 <span style="color: #66d9ef">public</span> <span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">main</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">String</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">args</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">UnknownHostException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">address</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;localhost&quot;</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">port</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">25</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">maxRequestsInQueue</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">10</span><span style="color: #f92672">;</span>

    <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
       <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">format</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Starting SMTP server at %s on port %s\n\n&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">address</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">port</span><span style="color: #f92672">);</span>
       <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Created by Adam Presley (c) 2010&quot;</span><span style="color: #f92672">);</span>
       <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">out</span><span style="color: #f92672">.</span><span style="color: #a6e22e">println</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Visit http://www.adampresley.com!!\n&quot;</span><span style="color: #f92672">);</span>
       <span style="color: #f8f8f2">SmtpServer</span> <span style="color: #f8f8f2">server</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">SmtpServer</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">address</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">port</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">maxRequestsInQueue</span><span style="color: #f92672">);</span>

       <span style="color: #f8f8f2">server</span><span style="color: #f92672">.</span><span style="color: #a6e22e">start</span><span style="color: #f92672">();</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Exception</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>

    <span style="color: #f92672">}</span>
 <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>
</p>

<p>Now you are ready to run that thing! Go ahead, run it. To test it, create a
ColdFusion page with the following code, then run it.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>  <span style="color: #f8f8f2">&lt;cfmail</span> <span style="color: #f8f8f2">from</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;from@address.com&quot;</span> <span style="color: #f8f8f2">to</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;to@address.com&quot;</span> <span style="color: #f8f8f2">subject</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;Test Mail Server&quot;</span><span style="color: #f8f8f2">&gt;</span>Test<span style="color: #f8f8f2">&lt;/cfmail&gt;</span>
</pre></div>
</p>

<p>Ok, so why reinvent the wheel? Cause sometimes it&rsquo;s fun to. Happy
coding!</p>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fadampresley.com%2fpost%2fcreating-a-smtp-mail-server-for-development%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=Creating%20a%20SMTP%20Mail%20Server%20for%20Development&amp;url=http%3a%2f%2fadampresley.com%2fpost%2fcreating-a-smtp-mail-server-for-development%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fadampresley.com%2fpost%2fcreating-a-smtp-mail-server-for-development%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fadampresley.com%2fpost%2fcreating-a-smtp-mail-server-for-development%2f&title=Creating%20a%20SMTP%20Mail%20Server%20for%20Development" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'adampresleyblog';
    var disqus_identifier = 'http:\/\/adampresley.com\/post\/creating-a-smtp-mail-server-for-development\/';
    var disqus_title = 'Creating a SMTP Mail Server for Development';
    var disqus_url = 'http:\/\/adampresley.com\/post\/creating-a-smtp-mail-server-for-development\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
  <img class="profile-image" src="http://adampresley.com/assets/adampresley/images/adam-bowtie.png" alt="Adam Presley" />
  <p class="name"> 
  <strong>Adam Presley</strong></p>
  <p class="address">Texas, USA</p>
  <p class="link"></p>
  <ul class="social">
    
<li><a href="//twitter.com/adampresley" class="icon-twitter" target="_blank" title="Twitter"></a></li>













<li><a href="//github.com/adampresley" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://adampresley.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://adampresley.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2016 &middot; Adam Presley. All Rights Reserved. Powered by <a href="http://gohugo.io">Hugo</a>.</p>
  </div>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/adampresley.com\/js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://adampresley.com/js/plugins.js"></script>

<!-- Google Analytics -->
<script>
  var _gaq=[['_setAccount','UA-44927419-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

