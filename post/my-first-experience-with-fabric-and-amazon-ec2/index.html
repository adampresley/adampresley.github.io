<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Adam.Blog()</title>
        <meta name="author">
        <meta name="description" content="I&#39;m bringin&#39; nerdy back">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.16-DEV" />
          <link href="http://adampresley.com/post/index.xml" rel="alternate" type="application/rss+xml" title="Adam.Blog()" />
          <link href="http://adampresley.com/post/index.xml" rel="feed" type="application/rss+xml" title="Adam.Blog()" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://adampresley.com/css/styles.css">
        <link rel="icon" href="http://adampresley.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://adampresley.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://adampresley.com/css/highlightjs/monokai.css">
        <script src="http://adampresley.com/js/vendor/modernizr-2.8.0.min.js"></script>
        <style>
        .site-header h2 .logo {
        background: url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://adampresley.com/assets/images/code-background-screenshot.png);
        }}
       .site-header {
         background: #2a373d url(http://adampresley.com/assets/images/code-background-screenshot.png) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2>Adam.Blog()</h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://adampresley.com/" title="">&laquo; </a>
            
<h1><a href="http://adampresley.com/post/my-first-experience-with-fabric-and-amazon-ec2/" title="My First Experience with Fabric and Amazon EC2">My First Experience with Fabric and Amazon EC2</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2012.10.17">2012.10.17</time>

    &middot; 
        
        <a href="http://adampresley.com/tags/python">python</a>, 
        
        <a href="http://adampresley.com/tags/deployment">deployment</a>
        
    

</span>
</footer>

            <p>I&rsquo;ve been working on a few projects and I have been in the process of
moving them to Amazon EC2. Up until this point I have been writing Bash
shell scripts, connecting to my servers and EC2 instances via SSH, then
running the shell scripts manually. Then I learned about <a href="http://docs.fabfile.org/">Fabric</a>, and
I wish I had seen this sooner. Fabric is a command-line tool and Python
library for executing local and remote shell commands. Fabric can also
connect to remote servers over SSH and execute commands. This basically
renders me antique. :) I&rsquo;m OK with this. In my setup I have a deployment
key on each EC2 instance that is used to checkout the Git repository.
This repository is the home of the web application. From here I would
usually update a file named <strong>config.py</strong> to turn off <em>Debug</em> which has
my application bind to a different port, etc&hellip; I also run a script
named <strong>bundle.py</strong> that takes all my CSS and JS files, combines and
minifies them, then changes the includes in the main layout template to
point to these files instead of the individual ones. Now, however, I can
automate those tasks with a single command using Fabric.</p>

<p>Below is an example of how I am using Fabric and Boto (for Amazon) to
iterate over my EC2 instances, reset the repository (undoing all local
changes), pull down the latest code, fix the config file and bundle.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">from</span> <span style="color: #f8f8f2">__future__</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">with_statement</span>

<span style="color: #f92672">import</span> <span style="color: #f8f8f2">fabric</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">boto</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">boto.ec2</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">time</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">fabric.api</span> <span style="color: #f92672">import</span> <span style="color: #f92672">*</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">fabric.colors</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">green,</span> <span style="color: #f8f8f2">yellow</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">boto.ec2.connection</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">EC2Connection</span>

<span style="color: #f8f8f2">ACCESS_KEY_ID</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;PUT YOUR KEY HERE&quot;</span>
<span style="color: #f8f8f2">SECRET_ACCESS_KEY</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;PUT YOUR ACCESS KEY HERE&quot;</span>

<span style="color: #f8f8f2">REPOS</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[</span>
    <span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;/path/to/repo&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;origin&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;master&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">]</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_connect</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">EC2Connection(ACCESS_KEY_ID,</span> <span style="color: #f8f8f2">SECRET_ACCESS_KEY)</span>

<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_getInstances</span><span style="color: #f8f8f2">():</span>
    <span style="color: #f8f8f2">connection</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">_connect()</span>
    <span style="color: #f8f8f2">reservations</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">connection</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_all_instances()</span>
    <span style="color: #f8f8f2">instances</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[]</span>

    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">green(</span><span style="color: #e6db74">&quot;** Getting instances **&quot;</span><span style="color: #f8f8f2">)</span>

    <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">reservation</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">reservations:</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">instance</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">reservation</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">instances:</span>
            <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;Instance: %s (%s) @ %s&quot;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">(instance</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">id,</span> <span style="color: #f8f8f2">instance</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">state,</span> <span style="color: #f8f8f2">instance</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">public_dns_name)</span>
            <span style="color: #f8f8f2">instances</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">append(instance</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">public_dns_name)</span>

    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">instances</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_gitReset</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">yellow(</span><span style="color: #e6db74">&quot;Resetting repository...&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">run(</span><span style="color: #e6db74">&quot;cd %s &amp;&amp; git checkout -f&quot;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">repo)</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_gitPull</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">yellow(</span><span style="color: #e6db74">&quot;Updating code...&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">run(</span><span style="color: #e6db74">&quot;cd %s &amp;&amp; git pull %s %s&quot;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">(env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">repo,</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">parent,</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">branch))</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_fixConfigFile</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">yellow(</span><span style="color: #e6db74">&quot;Updating config file...&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">run(</span><span style="color: #e6db74">&quot;sed -i &#39;s/DEBUG\s=\sTrue/DEBUG = False/g&#39; /path/to/repo/config.py&quot;</span><span style="color: #f8f8f2">)</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">_bundle</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">yellow(</span><span style="color: #e6db74">&quot;Bundling...&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">run(</span><span style="color: #e6db74">&quot;cd /path/to/repo/bin &amp;&amp; python ./bundle.py&quot;</span><span style="color: #f8f8f2">)</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">production</span><span style="color: #f8f8f2">():</span>
    <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">hosts</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[]</span>
    <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">user</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;ubuntu&quot;</span>
    <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">key_filename</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[</span> <span style="color: #e6db74">&quot;super-secret-key-pair-file.pem&quot;</span> <span style="color: #f8f8f2">]</span>

    <span style="color: #75715e">#</span>
    <span style="color: #75715e"># Get the DNS addresses for all the instances on this account</span>
    <span style="color: #75715e">#</span>
    <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">hosts</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">_getInstances()</span>


<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">updateServers</span><span style="color: #f8f8f2">():</span>
    <span style="color: #f8f8f2">require(</span><span style="color: #e6db74">&quot;hosts&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">provided_by</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[</span> <span style="color: #f8f8f2">production</span> <span style="color: #f8f8f2">])</span>

    <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;&quot;</span>
    <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">green(</span><span style="color: #e6db74">&quot;** Updating Servers **&quot;</span><span style="color: #f8f8f2">)</span>

    <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">repo,</span> <span style="color: #f8f8f2">parent,</span> <span style="color: #f8f8f2">branch</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">REPOS:</span>
        <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">repo</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">repo</span>
        <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">parent</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">parent</span>
        <span style="color: #f8f8f2">env</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">branch</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">branch</span>

        <span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">yellow(</span><span style="color: #e6db74">&quot;%s at %s/%s&quot;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">(repo,</span> <span style="color: #f8f8f2">parent,</span> <span style="color: #f8f8f2">branch))</span>

        <span style="color: #f8f8f2">_gitReset()</span>
        <span style="color: #f8f8f2">_gitPull()</span>
        <span style="color: #f8f8f2">_fixConfigFile()</span>
        <span style="color: #f8f8f2">_bundle()</span>
</pre></div>


            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fadampresley.com%2fpost%2fmy-first-experience-with-fabric-and-amazon-ec2%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=My%20First%20Experience%20with%20Fabric%20and%20Amazon%20EC2&amp;url=http%3a%2f%2fadampresley.com%2fpost%2fmy-first-experience-with-fabric-and-amazon-ec2%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fadampresley.com%2fpost%2fmy-first-experience-with-fabric-and-amazon-ec2%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fadampresley.com%2fpost%2fmy-first-experience-with-fabric-and-amazon-ec2%2f&title=My%20First%20Experience%20with%20Fabric%20and%20Amazon%20EC2" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'adampresleyblog';
    var disqus_identifier = 'http:\/\/adampresley.com\/post\/my-first-experience-with-fabric-and-amazon-ec2\/';
    var disqus_title = 'My First Experience with Fabric and Amazon EC2';
    var disqus_url = 'http:\/\/adampresley.com\/post\/my-first-experience-with-fabric-and-amazon-ec2\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
  <img class="profile-image" src="http://adampresley.com/assets/adampresley/images/adam-bowtie.png" alt="Adam Presley" />
  <p class="name"> 
  <strong>Adam Presley</strong></p>
  <p class="address">Texas, USA</p>
  <p class="link"></p>
  <ul class="social">
    
<li><a href="//twitter.com/adampresley" class="icon-twitter" target="_blank" title="Twitter"></a></li>













<li><a href="//github.com/adampresley" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://adampresley.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://adampresley.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2016 &middot; Adam Presley. All Rights Reserved. Powered by <a href="http://gohugo.io">Hugo</a>.</p>
  </div>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/adampresley.com\/js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://adampresley.com/js/plugins.js"></script>

<!-- Google Analytics -->
<script>
  var _gaq=[['_setAccount','UA-44927419-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

